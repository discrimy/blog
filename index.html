<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Bespealex's Blog</title>
        <link rel="stylesheet" href="https://discrimy.github.io/theme/css/main.css" />
        <link href="https://discrimy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bespealex's Blog Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://discrimy.github.io/">Bespealex's Blog</a></h1>
                <nav><ul>
                    <li><a href="https://discrimy.github.io/pages/about-me.html">About me</a></li>
                    <li><a href="https://discrimy.github.io/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://discrimy.github.io/nextprevious-model-in-django-orm.html">Next/Previous model in Django ORM</a></h1>
<footer class="post-info">
        <abbr class="published" title="2024-08-19T00:00:00+03:00">
                Published: Пн 19 августа 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info --><h2>Task</h2>
<p>I had a task: there is a table of posts <code>Post</code> with dynamic ordering based on user's input (newest first, by views count, etc.). I need to add button <code>Next</code> and <code>Previous</code> button on each posts' page. Ordering must be preserved between list view and serfing between posts.</p>
<h2>Solution</h2>
<p>Preserving ordering between pages of list of posts and particular posts is trivial: just preserve query param of ordering in links. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># Link to list of pages</span>
<span class="s2">&quot;/posts/?order=newest&quot;</span>
<span class="c1"># Link to post</span>
<span class="s2">&quot;/posts/123/?order=newest&quot;</span>
</code></pre></div>

<p>Getting next and previous models is trickier.</p>
<h3>Return to ~~monkey~~ SQL</h3>
<p>It's good to solve a difficult problem in Django ORM by solving it in SQL before. Google leads me to the solution with using window functions. I won't explain what window functions are and how to use them (there are plenty of posts in the Internet and there're a way better at this). The part is needed for me are functions <code>Lag</code> and <code>Lead</code>. 
IDs are enough for me (I don't actually need next/prev models themselves, just IDs to build links).</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- I use PostgreSQL btw</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="o">*</span><span class="p">,</span>
<span class="w">    </span><span class="n">LAG</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dt_created</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prev_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">LEAD</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dt_created</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">next_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">posts</span>
<span class="k">WHERE</span><span class="w"> </span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="k">ilike</span><span class="w"> </span><span class="ss">&quot;%experiment%&quot;</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dt_created</span><span class="w"> </span><span class="k">DESC</span>
</code></pre></div>

<p>But there's a problem: <code>id = 123</code> clause removes all other rows from the result, and <code>LEAD</code> and <code>LAG</code> window functions returns nothing. The solution is to query next/prev ids in separate query and attach it later.</p>
<div class="highlight"><pre><span></span><code><span class="k">WITH</span><span class="w"> </span><span class="ss">&quot;cte&quot;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">        </span><span class="n">id</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">LAG</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dt_created</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prev_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">LEAD</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dt_created</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">next_id</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">posts</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">ILIKE</span><span class="w"> </span><span class="ss">&quot;%experiment%&quot;</span>
<span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">cte</span><span class="p">.</span><span class="n">prev_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prev_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">cte</span><span class="p">.</span><span class="n">next_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">next_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">posts</span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">cte</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cte</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="k">ILIKE</span><span class="w"> </span><span class="ss">&quot;%experiment%&quot;</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>
</code></pre></div>

<p>Great, it returns the result, so we need to migrate the solution to Django ORM.</p>
<h3>Django ORM way</h3>
<p>We used <code>CTE</code> to write a SQL query, so we need them in Django ORM too. Hopefully there'is a package <a href="https://github.com/dimagi/django-cte"><code>django-cte</code></a> to help us! Also I want solution to be composeable with the rest of QuerySet's methods, so it will be a method too.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">django_cte</span>

<span class="k">class</span> <span class="nc">PostQuerySet</span><span class="p">(</span><span class="n">django_cte</span><span class="o">.</span><span class="n">CTEQuerySet</span><span class="p">[</span><span class="s2">&quot;Post&quot;</span><span class="p">]):</span>
    <span class="k">def</span> <span class="nf">with_prev_next_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="n">queryset_cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">prev_id</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span><span class="n">expression</span><span class="o">=</span><span class="n">Lag</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">order_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">),</span>
            <span class="n">next_id</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span><span class="n">expression</span><span class="o">=</span><span class="n">Lead</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">order_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>  <span class="c1"># empty order_by() removes ordering because it&#39;s obsolete in CTE query part</span>
        <span class="n">cte</span> <span class="o">=</span> <span class="n">django_cte</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">queryset_cte</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;prev_id&quot;</span><span class="p">,</span> <span class="s2">&quot;next_id&quot;</span><span class="p">))</span>  <span class="c1"># select ids only</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cte</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">cte</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># `INNER JOIN` part</span>
            <span class="o">.</span><span class="n">with_cte</span><span class="p">(</span><span class="n">cte</span><span class="p">)</span>  <span class="c1"># `WITH &quot;cte&quot; (...)` part</span>
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">prev_id</span><span class="o">=</span><span class="n">cte</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">prev_id</span><span class="p">,</span>
                <span class="n">next_id</span><span class="o">=</span><span class="n">cte</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">next_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span>

<span class="c1"># Later in your code</span>

<span class="n">queryset</span> <span class="o">=</span> <span class="n">Posts</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="c1"># Apply ordering first</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-dt_created&quot;</span><span class="p">)</span>
<span class="c1"># Attach next/prev ids later</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">with_prev_next_ids</span><span class="p">()</span>
<span class="c1"># (Optional) Get 1 object only, ignore if you need list of objects with ids</span>
<span class="n">post</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</code></pre></div>

<p>Next/Prev button work now, everyone is happy.</p>
<h2>Optimization</h2>
<p>Next/Prev ID calculation can be a hard task for DB and leads to slow query. But there is a trick: usually (90%) post views do not use these buttons, so it would be better to postpone calculation of next/prev IDs from post's page loading to click on the buttons.</p>
<ul>
<li>User loads page with post, both buttons leads to <code>/posts/&lt;next/prev&gt;/?&lt;query&gt;</code></li>
<li>User clicks a button</li>
<li>Server performs actual filtering and ordering and gets next/prev ID</li>
<li>Server replies with redirect to next/prev post using retrieved ID</li>
</ul>
<p>Post page is fast as it was before, next/prev buttons works. Everyone is more happier. Well, there is a downside: you cannot disable next/prev button when there's no next or prev post because you don't you it on post load stage. </p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://discrimy.github.io/what-to-read-2.html" rel="bookmark"
                           title="Permalink to What to Read 2">What to Read 2</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-05-21T08:58:10+03:00">
                Published: Вт 21 мая 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h1>What to read #2</h1>
<p>List of links of interest materials to read with short description.</p>
<h2><a href="https://olano.dev/blog/code-is-run-more-than-read">Code is run more than read</a></h2>
<p>Don't forget about priorities in software development.</p>
<blockquote>
<p><strong>user &gt; ops &gt; dev</strong></p>
<p><strong>biz &gt; ops &gt; dev</strong></p>
<p><strong>biz ≹ user</strong></p>
</blockquote>
<h2><a href="https://adamj.eu/tech/2021/05/07/python-type-hints-use-object-instead-of-any/">Use <code>object</code> instead of <code>Any</code></a></h2>
<p>In Python typing, <code>Any</code> <strong>disables</strong> checks. If you don't …</p>
                <a class="readmore" href="https://discrimy.github.io/what-to-read-2.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://discrimy.github.io/how-to-setup-secure-remote-storage-from-cloud-storage-guide.html" rel="bookmark"
                           title="Permalink to How to setup secure remote storage from cloud storage (guide)">How to setup secure remote storage from cloud storage (guide)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-08-14T23:23:00+03:00">
                Published: Пн 14 августа 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h1>How to setup secure remote storage from cloud storage (guide)</h1>
<p>I thought about secure encrypted file storage for a long time. Most cloud providers doesn't encrypt file, so that means your files are not only yours but provider's too. Some providers which states they store files encrypted (like Mega) have …</p>
                <a class="readmore" href="https://discrimy.github.io/how-to-setup-secure-remote-storage-from-cloud-storage-guide.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://discrimy.github.io/what-to-read-1.html" rel="bookmark"
                           title="Permalink to What to read #1">What to read #1</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-07-02T12:15:49+03:00">
                Published: Вс 02 июля 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h1>What to read #1</h1>
<p>List of links of interest materials to read with short description.</p>
<h2><a href="https://nadh.in/blog/fomo-yamo/">FOMO? YAMO.</a></h2>
<p>Hype technologies and methodologies aren't necessery.</p>
<blockquote>
<p>Why is the file being rsync’d instead of an S3-Ansible-pipeline? — Why not?</p>
<p>Why is there a full fledged Node build environment for a page with a …</p></blockquote>
                <a class="readmore" href="https://discrimy.github.io/what-to-read-1.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://discrimy.github.io/full-and-partial-functions.html" rel="bookmark"
                           title="Permalink to "Full and Partial Functions"">"Full and Partial Functions"</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-05-08T20:29:03+03:00">
                Published: Пн 08 мая 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h2>Full and partial functions</h2>
<p>Functions in programming can be splitted into two categories:
1. Partial function - there is at least one combination of arguments that has no defined result. Usually it leads to undefined behaviour or raised exception
<img alt="" src="/images/full-and-partial-functions-partial.png"></p>
<div class="highlight"><pre><span></span><code><span class="c1"># What if `raw_number` cannot be parsed to integer? ValueError will be raised …</span></code></pre></div>
                <a class="readmore" href="https://discrimy.github.io/full-and-partial-functions.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://discrimy.github.io/parse-dont-validate.html" rel="bookmark"
                           title="Permalink to Parse, Don't Validate">Parse, Don't Validate</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-05-08T20:27:18+03:00">
                Published: Пн 08 мая 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h1>Parse, don't validate</h1>
<p>That the difference between parsing and validation? Well, let's give definitions for both of them.
- Parsing - converting some less structural data to some more structures. For example, converting <code>str</code> to <code>int</code> or json via <code>json.loads</code> it a parsing, not every <code>string</code> can be converted to them …</p>
                <a class="readmore" href="https://discrimy.github.io/parse-dont-validate.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://discrimy.github.io/pre-commit-advices.html" rel="bookmark"
                           title="Permalink to pre-commit Advices">pre-commit Advices</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-04-26T20:18:17+03:00">
                Published: Ср 26 апреля 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h2>What is pre-commit</h2>
<p>At first, let me remind what pre-commit is.
<a href="https://pre-commit.com">pre-commit</a> is a tool to manage git hooks inside your projects, package them and import them from other sources. Also it make very convinient to manage them using it's declarative YAML configuration.</p>
<p>Git hooks are useful if you have …</p>
                <a class="readmore" href="https://discrimy.github.io/pre-commit-advices.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://discrimy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>