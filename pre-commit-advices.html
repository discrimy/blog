<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>pre-commit Advices</title>
        <link rel="stylesheet" href="https://discrimy.github.io/theme/css/main.css" />
        <link href="https://discrimy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bespealex's Blog Atom Feed" />
        <meta name="description" content="What is pre-commit At first, let me remind what pre-commit is. pre-commit is a tool to manage git hooks inside your projects, package them and..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://discrimy.github.io/">Bespealex's Blog</a></h1>
                <nav><ul>
                    <li><a href="https://discrimy.github.io/pages/about-me.html">About me</a></li>
                    <li class="active"><a href="https://discrimy.github.io/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://discrimy.github.io/pre-commit-advices.html" rel="bookmark"
           title="Permalink to pre-commit Advices">pre-commit Advices</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-04-26T20:18:17+03:00">
                Published: Ср 26 апреля 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://discrimy.github.io/author/alexander-bespalov.html">Alexander Bespalov</a>
        </address>
<p>In <a href="https://discrimy.github.io/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <h2>What is pre-commit</h2>
<p>At first, let me remind what pre-commit is.
<a href="https://pre-commit.com">pre-commit</a> is a tool to manage git hooks inside your projects, package them and import them from other sources. Also it make very convinient to manage them using it's declarative YAML configuration.</p>
<p>Git hooks are useful if you have some linters/formatters, and you want to make sure your commited changes are checked by your dev tools.</p>
<h2>Advices</h2>
<h3>Prefer system hooks over hooks managed by pre-commit</h3>
<p>pre-commit suggests to use their environment management for hooks:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/psf/black</span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">22.10.0</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black</span>
</code></pre></div>

<p>Inside <code>black</code> repo there is defined hook that will be installed in separate python virtual environment alongside with it's dependencies. It may look good from programmer's perspective, but it introduces two problems:
- You can't run the linter/formatter by yourself. Especially it's useful with formatters, so you have to format code by yourself. Of course you can install the same tool using another package manager, but it leads to another problem.
- If you have tool installed via <code>pre-commit</code> and another package manager, then their versions can differ. It applies to list of plugins too, so you can end to have a different set of linters with their plugins inside <code>pre-commit</code> and your dev environment.</p>
<p>The solution is simple: <strong>install tools outside pre-commit and use <code>language: system</code> to run them</strong>. For example, we're using <code>poetry</code> as package manager, so we use something like this:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">  </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black</span>
<span class="w">      </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run black</span><span class="w">  </span><span class="c1"># poetry run ... ensures to run command inside it&#39;s venv</span>
<span class="w">      </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
</code></pre></div>

<p>It uses the same <code>black</code> as you have inside <code>venv</code>. The same applies to <code>flake8</code> and it's plugins.</p>
<h3>pre-commit and CI</h3>
<p>CI is a place where our code is checked, built, tested and deployed. And it's important to ensure checks which are ran locally on developers' machines and checks inside CI are the same. So <code>lint</code> job should consist of <code>pre-commit</code> calling only. </p>
<div class="highlight"><pre><span></span><code>pre-commit<span class="w"> </span>run<span class="w"> </span>--all<span class="w"> </span>--verbose
</code></pre></div>

<p>Of course base <code>Docker</code> image must provide <code>pre-commit</code> command. For <code>Python</code>-based projects you can use your package manager (<code>poetry</code> in dev section for example), install it via <code>pip</code> or some other way.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://discrimy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>